# Epoch Consensus Node Distributed Key Generation Smart contract

| Status        | (Proposed)       |
:-------------- |:---------------------------------------------------- |
| **FLIP #**    | [313](https://github.com/onflow/flow/pull/NNN) (update when you have PR #)|
| **Feature PR** | [DKG Contract](https://github.com/onflow/flow-core-contracts/pull/108) |
| **Author(s)** | Josh Hannan (joshua.hannan@dapperlabs.com) |
| **Sponsor**   | Josh Hannan (joshua.hannan@dapperlabs.com)            |
| **Updated**   | 2021-03-22                                           |

## Objective

Enable distributed key generation for the proposed epoch.
The key generation mechanism is implemented in a Cadence smart contract.

## Motivation

When epochs are fully implemented on Flow, every consensus node
has to participate in the distributed key generation process
by posting messages on a shared whiteboard, parsing the messages,
and submitting final public key arrays with the final group key.

The generating of whiteboard messages and key arrays is left to the node software, but the smart contract will act
as a record of messages and final submissions for the nodes and an arbiter for which nodes are eligible to vote.

## User Benefit

The benefits of implementing this as a smart contract are:
* Easier auditability
* Easier upgradability without having to perform a fork
* Integration with other epoch-related smart contracts

## Design Proposal

### Assumptions and Design Goals (Up for discussion)
* No imports: DKG should be as self contained as possible and not directly rely
on any other smart contracts. 
* No exessive gas: All operations should prioritize efficiency and attempt to be O(1) time complexity
* Node software will primarily be submitting these transactions. They will not be initiated by a human.
* Final submissions for a node can only be submitted by the node a single time. They cannot be submitted by anyone else.
* The only actions nodes should have to take after registering is posting messages to the whiteboard and submitting a single final submission.
* The epoch smart contract will monitor the DKG contract for voting completion status

### High Level Design

`Message` is a struct that represents a single whiteboard message from a consensus node.
The smart contract cannot verify the content of a message, so the message just has a raw `String` for its contents, as well as other identifying information for the node ID that submitted it.
```cadence
pub struct Message {

    pub let nodeID: String

    pub let content: String

    init(nodeID: String, content: String) {
        self.nodeID = nodeID
        self.content = content
    }
}
```

The contract also defines a `Participant` resource. This resource is claimed by consensus nodes by calling a 
privledged function to create a new object. It lives in the accounts of consensus nodes and **only needs to be claimed once per node**. Once a consensus node has claimed their `Participant` resource, it is valid to vote for every subsequent epoch where they are a valid node operator.
when the consensus node has been confirmed as a participant, the node uses this object to exchange messages via the public whiteboard and submit their final key shares and group public key.
```cadence
pub resource Participant {

    pub let nodeID: String

    // Posts a whiteboard message to the contract
    pub fun postMessage(_ content: String) {
    }

    /// Sends the final key vector submission. 
    /// Can only be called by consensus nodes that are registered.
    pub fun sendFinalSubmission(_ submission: [String]) {
    }
}
```

The contract also defines an `Admin` resource that has the authority to create new `Participant`s, start the dkg phase,
and end the dkg phase. Messages are only allowed to be submitted while the dkg phase is in progress, 
and submitting is only allowed to be stopped once the dkg process has completed: **(n-1)/2 nodes have submitted**
```cadence
        /// Creates a new Participant resource for a consensus node
        pub fun createParticipant(nodeID: String): @Participant {}

        /// Resets all the fields for tracking the current DKG process
        /// and sets the given node IDs as registered
        pub fun startDKG(nodeIDs: [String]) {}

        pub fun endDKG() {}
```
The `Admin` object lives in the Flow Service Account and is controlled by the central `FlowEpoch` contract,
which will be detailed in another FLIP. The epoch contract will handle the complexity of
restricting `Voter` creation and timing the beginning and end of the dkg.

The smart contract also defines public getter functions to query all of the public information in the contract,
such as voting completion status, whiteboard messages, etc.

### Drawbacks

* Still researching alternative architectures. There could be better options.

### Alternatives Considered

* Considered deeper coupling with the other epoch contracts, 
but this would make upgrading and unit testing more challenging

### Performance Implications

* checking `dkgCompleted` has to iterate through all unique submissions, which could take a lot of time and gas.
* checking `submissionsEqual` has to iterate through all unique submission, which could take a lot of time and gas.
* `startDKG` has to iterate through all nodes to initialize contract field each epoch, which could take a lot of time and gas. This one is harder to avoid though, but it is only called by the service account, so isn't as much of a problem.

### Dependencies

* Dependencies: no new dependencies
* Dependent projects: 
    * flow-core-contracts (adding `FlowDKG` contract),

### Engineering Impact

* minimal changes to build time and test time.
* Joshua Hannan will maintain the code and unit tests. 

### Tutorials and Examples

* See [DKG unit tests](https://github.com/onflow/flow-core-contracts/blob/feature/epochs/lib/go/test/flow_dkg_test.go) for how this process is handled.
* See the [DKG transactions directory](https://github.com/onflow/flow-core-contracts/tree/feature/epochs/transactions/dkg) for example transactions

### User Impact

* No user impact until all epoch features are enabled, which will be detailed in another document.

## Related Issues

Epoch smart contract is related, but out of scope from this proposal besides some
vague assumptions of how it will behave in relation.

## Questions and Discussion Topics

Seed this with open questions you require feedback on from the FLIP process. 
What parts of the design still need to be defined?